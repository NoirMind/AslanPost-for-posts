<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>üì¶ –ü–æ—á—Ç–æ–≤—ã–π –º–∞–Ω–∏—Ñ–µ—Å—Ç ‚Äî Pro</title>

<!-- jsPDF + AutoTable -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

<!-- –®—Ä–∏—Ñ—Ç -->
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">

<style>
  /* --------------------------------------
     –¢–µ–º–∞: —Å–æ–≤—Ä–µ–º–µ–Ω–Ω–∞—è, –∫–æ–Ω—Ç—Ä–∞—Å—Ç–Ω–∞—è, –¥–æ—Å—Ç—É–ø–Ω–∞—è
     -------------------------------------- */
  :root{
    --bg: #0f1724;
    --surface: #0b1220;
    --card: #0f1724;
    --muted: #94a3b8;
    --text: #e6eef8;
    --accent1: #7c3aed; /* —Ñ–∏–æ–ª–µ—Ç–æ–≤—ã–π (trendy) */
    --accent2: #06b6d4; /* –±–∏—Ä—é–∑–æ–≤—ã–π (accent) */
    --success: #22c55e;
    --danger: #ef4444;
    --glass: rgba(255,255,255,0.03);
    --radius: 12px;
  }

  *{box-sizing:border-box}
  html,body{height:100%;margin:0;background:
    linear-gradient(180deg,#071029 0%, #081428 45%, #07182a 100%);color:var(--text);
    font-family:Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;}

  .wrap{max-width:1200px;margin:28px auto;padding:20px;border-radius:16px;
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    box-shadow: 0 6px 30px rgba(2,6,23,0.7);outline: 1px solid rgba(255,255,255,0.02);}

  header{display:flex;gap:16px;align-items:center;justify-content:space-between}
  h1{font-size:20px;margin:0;font-weight:800;letter-spacing:0.2px}
  .subtitle{color:var(--muted);font-size:13px}

  /* Top area */
  .top{display:flex;gap:16px;margin-top:18px;flex-wrap:wrap}
  .box{background:var(--glass);padding:16px;border-radius:var(--radius);flex:1;min-width:260px}
  .box.small{flex:0 0 280px}
  label{display:block;font-size:13px;color:var(--muted);margin-bottom:6px}
  input[type="text"], input[type="tel"], input[type="number"], select, textarea {
    width:100%;padding:10px;border-radius:10px;border:1px solid rgba(255,255,255,0.06);
    background: rgba(255,255,255,0.02); color:var(--text); outline:none; font-size:14px;
  }
  input:focus, textarea:focus, select:focus { box-shadow:0 0 0 4px rgba(124,58,237,0.12); border-color:var(--accent1) }

  /* Couriers */
  .courier-list{display:flex;flex-direction:column;gap:8px}
  .courier{display:flex;align-items:center;gap:12px;padding:10px;border-radius:10px;background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));cursor:pointer; border:1px solid rgba(255,255,255,0.03)}
  .courier.active{box-shadow:0 6px 18px rgba(124,58,237,0.12);border:1px solid rgba(124,58,237,0.35)}
  .courier .dot{width:10px;height:10px;border-radius:50%;background:var(--accent2)}
  .courier strong{display:block;font-weight:700}

  /* Scanner zone */
  .scanner textarea{min-height:90px;resize:vertical}
  .actions{display:flex;gap:8px;margin-top:10px;flex-wrap:wrap}
  .btn{padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:700;color:#071428}
  .btn.primary{background:linear-gradient(90deg,var(--accent1),#5b21b6);color:var(--text)}
  .btn.ghost{background:transparent;border:1px solid rgba(255,255,255,0.06);color:var(--text)}
  .btn.danger{background:var(--danger);color:white}

  /* Table */
  .table-wrap{margin-top:20px;overflow:auto;border-radius:12px}
  table{width:100%;border-collapse:collapse;min-width:900px}
  th,td{padding:12px 10px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:left;font-size:14px}
  thead th{position:sticky;top:0;background:linear-gradient(90deg,var(--accent1),#5b21b6);color:white;font-weight:700}
  tbody tr:hover{background:linear-gradient(90deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01))}
  td[contenteditable="true"]{background:rgba(255,255,255,0.02);border-radius:6px}

  .right{text-align:right}
  .muted{color:var(--muted);font-size:13px}

  /* Footer area for totals and signatures */
  .footer-area{display:flex;gap:20px;align-items:flex-start;margin-top:18px;flex-wrap:wrap}
  .totals{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:12px;border-radius:12px;min-width:220px}
  .signature-pad{background:linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));padding:12px;border-radius:12px;flex:1}
  canvas{background:white;border-radius:8px;width:100%;height:120px;display:block}

  /* small screens */
  @media (max-width:880px){
    .top{flex-direction:column}
    table{min-width:700px}
  }
</style>
</head>
<body>
  <div class="wrap" role="main" aria-labelledby="pageTitle">
    <header>
      <div>
        <h1 id="pageTitle">üì¶ –ü–æ—á—Ç–æ–≤—ã–π –º–∞–Ω–∏—Ñ–µ—Å—Ç ‚Äî Pro</h1>
        <div class="subtitle">–°–∫–∞–Ω–∏—Ä—É–π —Ç—Ä–µ–∫–∏, –ø—Ä–∞–≤—å —Å—Ç—Ä–æ–∫–∏ –∫–∞–∫ –≤ Excel, –ø–µ—á–∞—Ç–∞–π PDF —Å –ø–æ–¥–ø–∏—Å—è–º–∏</div>
      </div>
      <div class="muted">Fargo ‚Äî Manifest System</div>
    </header>

    <!-- TOP: Couriers + Scanner + Quick add -->
    <div class="top" role="region" aria-label="Top controls">
      <!-- Couriers (left) -->
      <div class="box small" aria-labelledby="courLabel">
        <div id="courLabel" class="muted">–í—ã–±–µ—Ä–∏—Ç–µ –∫—É—Ä—å–µ—Ä–∞</div>
        <div class="courier-list" id="couriers" role="list">
          <!-- JS –∑–∞–ø–æ–ª–Ω–∏—Ç —Å–ø–∏—Å–æ–∫ –∫—É—Ä—å–µ—Ä–æ–≤ -->
        </div>
      </div>

      <!-- Scanner -->
      <div class="box" aria-labelledby="scanLabel">
        <div id="scanLabel"><strong>–ó–æ–Ω–∞ —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è / –º—É–ª—å—Ç–∏-—Å–∫–∞–Ω</strong> <span class="muted">(–∫–∞–∂–¥—ã–π —Ç—Ä–µ–∫ ‚Äî –Ω–æ–≤–∞—è —Å—Ç—Ä–æ–∫–∞)</span></div>
        <label for="scanner" class="muted">–§–æ—Ä–º–∞—Ç (–µ—Å–ª–∏ —Å–∫–∞–Ω–µ—Ä –≤—ã–¥–∞—ë—Ç —Ç–æ–ª—å–∫–æ ID, –ø–æ—Å–ª–µ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–ø–æ–ª–Ω–∏—Ç–µ —è—á–µ–π–∫–∏ –≤—Ä—É—á–Ω—É—é)</label>
        <textarea id="scanner" aria-label="Scanner input" placeholder="–ü—Ä–∏–º–µ—Ä: TRK123456 | –ò–≤–∞–Ω–æ–≤ –ò–≤–∞–Ω | +998901234567 | –¢–∞—à–∫–µ–Ω—Ç, –ê—Ö–∞–Ω–≥–∞—Ä–∞–Ω 12 | 250000
–ò–ª–∏ –ø—Ä–æ—Å—Ç–æ: TRK123457 (–ø–æ –æ–¥–Ω–æ–º—É —Ç—Ä–µ–∫—É –Ω–∞ —Å—Ç—Ä–æ–∫—É)"></textarea>

        <div class="actions">
          <button class="btn primary" id="btnAdd">–î–æ–±–∞–≤–∏—Ç—å —Å–∫–∞–Ω—ã</button>
          <button class="btn ghost" id="btnPaste" title="–í—Å—Ç–∞–≤–∏—Ç—å –∏–∑ –±—É—Ñ–µ—Ä–∞">–í—Å—Ç–∞–≤–∏—Ç—å</button>
          <button class="btn ghost" id="btnClear">–û—á–∏—Å—Ç–∏—Ç—å –ø–æ–ª–µ</button>
        </div>

        <div class="muted" style="margin-top:10px">–°–æ–≤–µ—Ç: –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–æ USB-—Å–∫–∞–Ω–µ—Ä–æ–≤ —ç–º—É–ª–∏—Ä—É—é—Ç –∫–ª–∞–≤–∏–∞—Ç—É—Ä—É ‚Äî –æ–Ω–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –≤—Å—Ç–∞–≤—è—Ç —Å—Ç—Ä–æ–∫—É –∏ –Ω–∞–∂–º—É—Ç Enter.</div>
      </div>

      <!-- Quick single add -->
      <div class="box small" aria-labelledby="quickLabel">
        <div id="quickLabel"><strong>–ë—ã—Å—Ç—Ä–æ –¥–æ–±–∞–≤–∏—Ç—å –æ–¥–Ω–æ</strong></div>
        <label for="qId">ID –ø–æ—á—Ç—ã</label><input id="qId" type="text" />
        <label for="qName">–ü–æ–ª—É—á–∞—Ç–µ–ª—å</label><input id="qName" type="text" />
        <label for="qPhone">–¢–µ–ª–µ—Ñ–æ–Ω</label><input id="qPhone" type="tel" />
        <label for="qAddr">–ê–¥—Ä–µ—Å</label><input id="qAddr" type="text" />
        <label for="qSum">–°—É–º–º–∞ (—Å—É–º)</label><input id="qSum" type="number" />
        <div class="actions">
          <button class="btn primary" id="btnQuickAdd">–î–æ–±–∞–≤–∏—Ç—å –≤ —Ç–∞–±–ª–∏—Ü—É</button>
        </div>
      </div>
    </div>

    <!-- Table -->
    <div class="table-wrap" role="region" aria-label="Manifest table">
      <table id="manifestTable" aria-describedby="tableDesc">
        <thead>
          <tr>
            <th scope="col">#</th>
            <th scope="col">ID –ø–æ—á—Ç—ã</th>
            <th scope="col">–ü–æ–ª—É—á–∞—Ç–µ–ª—å</th>
            <th scope="col">–¢–µ–ª–µ—Ñ–æ–Ω</th>
            <th scope="col">–ê–¥—Ä–µ—Å</th>
            <th scope="col" class="right">–°—É–º–º–∞ (—Å—É–º)</th>
            <th scope="col">–î–µ–π—Å—Ç–≤–∏–µ</th>
          </tr>
        </thead>
        <tbody></tbody>
        <tfoot>
          <tr>
            <td colspan="5" class="right muted">–ò—Ç–æ–≥–æ:</td>
            <td class="right" id="totalSum">0</td>
            <td></td>
          </tr>
        </tfoot>
      </table>
      <div id="tableDesc" class="muted" style="padding:8px 0">–¢–∞–±–ª–∏—Ü–∞ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º–∞—è ‚Äî –∫–ª–∏–∫–Ω–∏—Ç–µ –ø–æ —è—á–µ–π–∫–µ (–∫—Ä–æ–º–µ –∫–æ–ª–æ–Ω–∫–∏ # –∏ –î–µ–π—Å—Ç–≤–∏–µ), —á—Ç–æ–±—ã –∏–∑–º–µ–Ω–∏—Ç—å –¥–∞–Ω–Ω—ã–µ.</div>
    </div>

    <!-- Footer area: totals + signatures + export -->
    <div class="footer-area" role="region" aria-label="Footer controls">
      <div class="totals" aria-live="polite">
        <div class="muted">–û–±—â–∞—è —Å—É–º–º–∞:</div>
        <div style="font-size:20px;font-weight:800" id="bigTotal">0 —Å—É–º</div>
        <div style="margin-top:12px"><label class="muted">–î–∞—Ç–∞ –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞</label>
          <input id="manifestDate" type="text" value="" aria-label="manifest date" /></div>
        <div style="margin-top:12px">
          <label class="muted">–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
          <input id="manifestNote" type="text" placeholder="–ù–∞–ø—Ä–∏–º–µ—Ä: –°–º–µ–Ω–∞ —É—Ç—Ä–æ 2025-08-31" />
        </div>
      </div>

      <div class="signature-pad">
        <div class="muted">–ü–æ–¥–ø–∏—Å—å –∫—É—Ä—å–µ—Ä–∞ (–æ–Ω —Ä–∞—Å–ø–∏—Å—ã–≤–∞–µ—Ç—Å—è –ø–æ—Å–ª–µ –ø–æ–ª—É—á–µ–Ω–∏—è)</div>
        <canvas id="signCourier" width="600" height="120" aria-label="–ü–æ–¥–ø–∏—Å—å –∫—É—Ä—å–µ—Ä–∞"></canvas>
        <div class="actions" style="margin-top:8px">
          <button class="btn ghost" id="clearCourier">–û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>
      </div>

      <div class="signature-pad">
        <div class="muted">–ü–æ–¥–ø–∏—Å—å –ø—Ä–∏–Ω–∏–º–∞—é—â–µ–≥–æ (—Ç—ã, —á—Ç–æ–±—ã –∑–∞—â–∏—Ç–∏—Ç—å —Å–µ–±—è)</div>
        <canvas id="signReceiver" width="600" height="120" aria-label="–ü–æ–¥–ø–∏—Å—å –ø—Ä–∏–Ω–∏–º–∞—é—â–µ–≥–æ"></canvas>
        <div class="actions" style="margin-top:8px">
          <button class="btn ghost" id="clearReceiver">–û—á–∏—Å—Ç–∏—Ç—å</button>
        </div>
      </div>
    </div>

    <!-- Actions -->
    <div style="display:flex;gap:10px;margin-top:18px;align-items:center;flex-wrap:wrap">
      <button class="btn primary" id="btnExport">üìÑ –°–∫–∞—á–∞—Ç—å PDF –º–∞–Ω–∏—Ñ–µ—Å—Ç–∞</button>
      <button class="btn ghost" id="btnPrint">üñ®Ô∏è –ü–µ—á–∞—Ç—å</button>
      <button class="btn ghost" id="btnExportCSV">‚¨áÔ∏è –≠–∫—Å–ø–æ—Ä—Ç CSV</button>
      <button class="btn danger" id="btnClearTable">–û—á–∏—Å—Ç–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É</button>
    </div>
  </div>

<script>
/* ----------------------
   –î–∞–Ω–Ω—ã–µ –∫—É—Ä—å–µ—Ä–æ–≤ (—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ)
   ---------------------- */
const COURIERS = [
  "Ulug'bek Nuriyev",
  "Ulug'bek Jurabayev",
  "Otabek Saydullayev",
  "Dilshod Tadjibayev",
  "Muzaffar Aliyev",
  "Nomonjon"
];

/* ---------- Helper ---------- */
const qs = s => document.querySelector(s);
const qsa = s => Array.from(document.querySelectorAll(s));
const tbody = qs('#manifestTable tbody');
const totalSumEl = qs('#totalSum');
const bigTotalEl = qs('#bigTotal');
const manifestDate = qs('#manifestDate');
const manifestNote = qs('#manifestNote');

/* ---------- –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è UI ---------- */
function init() {
  // Couriers
  const clist = qs('#couriers');
  COURIERS.forEach((c, i) => {
    const el = document.createElement('div');
    el.className = 'courier';
    el.setAttribute('role','listitem');
    el.tabIndex = 0;
    el.innerHTML = `<div style="flex:1"><strong>${c}</strong><div class="muted">–ö—É—Ä—å–µ—Ä #${i+1}</div></div>`;
    el.addEventListener('click', ()=>selectCourier(el,c));
    el.addEventListener('keydown', (e)=>{ if(e.key==='Enter') selectCourier(el,c) });
    clist.appendChild(el);
    // –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é –≤—ã–¥–µ–ª—è–µ–º –ø–µ—Ä–≤–æ–≥–æ
    if(i===0) selectCourier(el,c);
  });

  // date
  manifestDate.value = new Date().toLocaleString();

  // –∫–Ω–æ–ø–∫–∏
  qs('#btnAdd').addEventListener('click', handleAddScans);
  qs('#btnPaste').addEventListener('click', handlePaste);
  qs('#btnClear').addEventListener('click', ()=>qs('#scanner').value='');
  qs('#btnQuickAdd').addEventListener('click', handleQuickAdd);
  qs('#btnExport').addEventListener('click', exportPDF);
  qs('#btnPrint').addEventListener('click', ()=>window.print());
  qs('#btnExportCSV').addEventListener('click', exportCSV);
  qs('#btnClearTable').addEventListener('click', clearTable);

  // –ø–æ–¥–ø–∏—Å–Ω—ã–µ pad
  initSignature('signCourier', 'clearCourier');
  initSignature('signReceiver', 'clearReceiver');

  // –¥–µ–ª–∞–µ–º –ø–µ—Ä–≤—É—é —Å—Ç—Ä–æ–∫—É –ø—É—Å—Ç–æ–π –ø–æ–¥—Å–∫–∞–∑–∫–æ–π
  //addRow({id:'TRK-example-001', name:'–ò–≤–∞–Ω –ò–≤–∞–Ω–æ–≤', phone:'+998901234567', addr:'–¢–∞—à–∫–µ–Ω—Ç, —É–ª. X, 12', sum:250000});
}
init();

/* ---------- Courier select ---------- */
let selectedCourier = COURIERS[0];
function selectCourier(el,name){
  qsa('.courier').forEach(c=>c.classList.remove('active'));
  el.classList.add('active');
  selectedCourier = name;
}

/* ---------- Add scans (–ø–∞—Ä—Å–∏–Ω–≥ textarea) ---------- */
/*
  –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º —Ñ–æ—Ä–º–∞—Ç —Å—Ç—Ä–æ–∫:
  1) –ü–æ–ª–Ω–∞—è —Å—Ç—Ä–æ–∫–∞: ID | –ò–º—è | –¢–µ–ª–µ—Ñ–æ–Ω | –ê–¥—Ä–µ—Å | –°—É–º–º–∞
  2) –¢–æ–ª—å–∫–æ ID: –≤ —ç—Ç–æ–º —Å–ª—É—á–∞–µ –¥–æ–±–∞–≤–ª—è–µ—Ç—Å—è —Å—Ç—Ä–æ–∫–∞ —Å –ø—É—Å—Ç—ã–º–∏ –ø–æ–ª—è–º–∏ (—Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ–º –≤—Ä—É—á–Ω—É—é)
  –†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å: '|' –∏–ª–∏ —Ç–∞–± –∏–ª–∏ –∑–∞–ø—è—Ç–∞—è; —Å—Ç—Ä–æ–∫–∏ —Ä–∞–∑–¥–µ–ª—è—é—Ç—Å—è –ø–µ—Ä–µ–≤–æ–¥–æ–º —Å—Ç—Ä–æ–∫–∏.
*/
function handleAddScans(){
  const raw = qs('#scanner').value.trim();
  if(!raw) { alert('–ü–æ–ª–µ —Å–∫–∞–Ω–µ—Ä–∞ –ø—É—Å—Ç–æ–µ'); return; }
  const lines = raw.split(/\r?\n/).map(l=>l.trim()).filter(Boolean);
  lines.forEach(line=>{
    // –ø—Ä–æ–±—É–µ–º —Ä–∞–∑–±–∏—Ç—å –ø–æ | –∏–ª–∏ \t –∏–ª–∏ ;
    let parts = line.split('|').map(p=>p.trim());
    if(parts.length===1){
      // –≤–æ–∑–º–æ–∂–Ω–æ —á–µ—Ä–µ–∑ —Ç–∞–± –∏–ª–∏ –∑–∞–ø—è—Ç—É—é
      if(line.includes('\t')) parts = line.split('\t').map(p=>p.trim());
      else if(line.includes(';')) parts = line.split(';').map(p=>p.trim());
      else if(line.split(',').length>=5) parts = line.split(',').map(p=>p.trim());
    }
    // –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º –≤ –æ–±—ä–µ–∫—Ç
    const obj = {
      id: parts[0] || '',
      name: parts[1] || '',
      phone: parts[2] || '',
      addr: parts[3] || '',
      sum: parts[4] ? Number(parts[4].replace(/\s|,|—Ä|—Å—É–º/g,'')) : 0
    };
    addRow(obj);
  });
  qs('#scanner').value = '';
  recalcTotals();
}

/* –≤—Å—Ç–∞–≤–∏—Ç—å –∏–∑ –±—É—Ñ–µ—Ä–∞ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ) */
async function handlePaste(){
  try{
    const text = await navigator.clipboard.readText();
    qs('#scanner').value = text;
  }catch(e){ alert('–ù–µ —É–¥–∞–ª–æ—Å—å –ø—Ä–æ—á–∏—Ç–∞—Ç—å –±—É—Ñ–µ—Ä –æ–±–º–µ–Ω–∞ (–ø–æ–ø—Ä–æ–±—É–π –≤—Ä—É—á–Ω—É—é)') }
}

/* –±—ã—Å—Ç—Ä—ã–π add */
function handleQuickAdd(){
  const id = qs('#qId').value.trim();
  if(!id){ alert('–í–≤–µ–¥–∏—Ç–µ ID'); return; }
  const obj = {
    id,
    name: qs('#qName').value.trim(),
    phone: qs('#qPhone').value.trim(),
    addr: qs('#qAddr').value.trim(),
    sum: Number(qs('#qSum').value || 0)
  };
  addRow(obj);
  // –æ—á–∏—Å—Ç–∏–º
  qs('#qId').value='';qs('#qName').value='';qs('#qPhone').value='';qs('#qAddr').value='';qs('#qSum').value='';
  recalcTotals();
}

/* ---------- –†–∞–±–æ—Ç–∞ —Å —Ç–∞–±–ª–∏—Ü–µ–π ---------- */
let rowCount = 0;
function addRow({id='', name='', phone='', addr='', sum=0}){
  rowCount++;
  const tr = document.createElement('tr');
  tr.innerHTML = `
    <td class="muted">${rowCount}</td>
    <td contenteditable="true" data-col="id" aria-label="ID">${escapeHtml(id)}</td>
    <td contenteditable="true" data-col="name" aria-label="–ü–æ–ª—É—á–∞—Ç–µ–ª—å">${escapeHtml(name)}</td>
    <td contenteditable="true" data-col="phone" aria-label="–¢–µ–ª–µ—Ñ–æ–Ω">${escapeHtml(phone)}</td>
    <td contenteditable="true" data-col="addr" aria-label="–ê–¥—Ä–µ—Å">${escapeHtml(addr)}</td>
    <td contenteditable="true" data-col="sum" aria-label="–°—É–º–º–∞" class="right">${Number(sum)||0}</td>
    <td class="muted">
      <button class="btn ghost" data-action="del">–£–¥–∞–ª–∏—Ç—å</button>
    </td>
  `;
  // —Å–ª—É—à–∞–µ–º —Å–æ–±—ã—Ç–∏—è —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏—è –∏ –∫–Ω–æ–ø–∫—É —É–¥–∞–ª–∏—Ç—å
  tr.addEventListener('input', (e)=> {
    // –µ—Å–ª–∏ —Ä–µ–¥–∞–∫—Ç–∏—Ä—É–µ—Ç—Å—è —Å—É–º–º–∞ ‚Äî –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º
    const target = e.target;
    if(target.dataset && target.dataset.col==='sum'){
      target.innerText = sanitizeNumber(target.innerText);
      recalcTotals();
    }
  });
  tr.querySelector('[data-action="del"]').addEventListener('click', ()=>{ tr.remove(); rebuildIndices(); recalcTotals(); });
  tbody.appendChild(tr);
}

/* sanitize —Ü–∏—Ñ—Ä –≤ —Å—É–º–º–µ */
function sanitizeNumber(text){
  const num = Number(String(text).replace(/[^\d]/g,''));
  return isNaN(num)?'0':String(num);
}

function escapeHtml(s=''){ return String(s).replace(/[&<>"]/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;'}[c]))}

/* –ü–µ—Ä–µ–ø—Ä–∏—Å–≤–∞–∏–≤–∞–µ–º –∏–Ω–¥–µ–∫—Å—ã –ø—Ä–∏ —É–¥–∞–ª–µ–Ω–∏–∏ */
function rebuildIndices(){
  rowCount = 0;
  qsa('#manifestTable tbody tr').forEach(tr=>{
    rowCount++;
    tr.cells[0].innerText = rowCount;
  });
}

/* –ü–µ—Ä–µ—Å—á—ë—Ç —Å—É–º–º */
function recalcTotals(){
  let total = 0;
  qsa('#manifestTable tbody tr').forEach(tr=>{
    const val = Number(tr.querySelector('td[data-col="sum"]')?.innerText.replace(/[^\d]/g,'') || 0);
    total += val;
  });
  totalSumEl.innerText = new Intl.NumberFormat().format(total);
  bigTotalEl.innerText = new Intl.NumberFormat().format(total) + ' —Å—É–º';
}

/* –û—á–∏—Å—Ç–∏—Ç—å —Ç–∞–±–ª–∏—Ü—É */
function clearTable(){
  if(!confirm('–í—ã —É–≤–µ—Ä–µ–Ω—ã? –û—á–∏—Å—Ç–∏—Ç—å –≤—Å—é —Ç–∞–±–ª–∏—Ü—É.')) return;
  tbody.innerHTML = ''; rowCount=0; recalcTotals();
}

/* –≠–∫—Å–ø–æ—Ä—Ç CSV */
function exportCSV(){
  const rows = [];
  rows.push(['‚Ññ','ID','–ü–æ–ª—É—á–∞—Ç–µ–ª—å','–¢–µ–ª–µ—Ñ–æ–Ω','–ê–¥—Ä–µ—Å','–°—É–º–º–∞']);
  qsa('#manifestTable tbody tr').forEach((tr,i)=>{
    const r = [
      i+1,
      tr.querySelector('td[data-col="id"]').innerText,
      tr.querySelector('td[data-col="name"]').innerText,
      tr.querySelector('td[data-col="phone"]').innerText,
      tr.querySelector('td[data-col="addr"]').innerText,
      tr.querySelector('td[data-col="sum"]').innerText
    ];
    rows.push(r.map(cell=>`"${String(cell).replace(/"/g,'""')}"`).join(','));
  });
  const csv = rows.join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href=url; a.download='manifest.csv'; a.click(); URL.revokeObjectURL(url);
}

/* ---------- Signature pads ---------- */
function initSignature(canvasId, btnClearId){
  const canvas = qs('#'+canvasId);
  const ctx = canvas.getContext('2d');
  ctx.fillStyle = '#fff'; ctx.fillRect(0,0,canvas.width,canvas.height);
  ctx.strokeStyle = '#000'; ctx.lineWidth = 2; ctx.lineCap='round';
  let drawing=false;
  function pos(e){
    const rect = canvas.getBoundingClientRect();
    if(e.touches && e.touches[0]) return {x: e.touches[0].clientX-rect.left, y: e.touches[0].clientY-rect.top};
    return {x: e.clientX-rect.left, y: e.clientY-rect.top};
  }
  canvas.addEventListener('mousedown', e=>{ drawing=true; const p=pos(e); ctx.beginPath(); ctx.moveTo(p.x,p.y); });
  canvas.addEventListener('mousemove', e=>{ if(!drawing) return; const p=pos(e); ctx.lineTo(p.x,p.y); ctx.stroke(); });
  window.addEventListener('mouseup', ()=>drawing=false);
  canvas.addEventListener('touchstart', e=>{ drawing=true; const p=pos(e); ctx.beginPath(); ctx.moveTo(p.x,p.y); e.preventDefault(); });
  canvas.addEventListener('touchmove', e=>{ if(!drawing) return; const p=pos(e); ctx.lineTo(p.x,p.y); ctx.stroke(); e.preventDefault(); });
  window.addEventListener('touchend', ()=>drawing=false);

  qs('#'+btnClearId).addEventListener('click', ()=>{ ctx.fillStyle='#fff'; ctx.fillRect(0,0,canvas.width,canvas.height); });
}

/* –ü–æ–ª—É—á–∏—Ç—å dataURL –ø–æ–¥–ø–∏—Å–∏ */
function getSignatureDataURL(id){
  const canvas = qs('#'+id);
  // –ï—Å–ª–∏ –±–µ–ª—ã–π ‚Äî —Å—á–∏—Ç–∞–µ–º –ø—É—Å—Ç–æ–π
  // –≤–æ–∑–≤—Ä–∞—â–∞–µ–º null –µ—Å–ª–∏ –ø—É—Å—Ç–∞—è
  try{
    const tmp = document.createElement('canvas'); tmp.width=canvas.width; tmp.height=canvas.height;
    const tctx = tmp.getContext('2d'); tctx.drawImage(canvas,0,0);
    const data = tctx.getImageData(0,0,tmp.width,tmp.height).data;
    // –ø—Ä–æ–≤–µ—Ä–∏–º –Ω–∞–ª–∏—á–∏–µ —Ç—ë–º–Ω—ã—Ö –ø–∏–∫—Å–µ–ª–µ–π
    let has=false;
    for(let i=0;i<data.length;i+=4){
      if(data[i]<250 || data[i+1]<250 || data[i+2]<250){ has=true; break; }
    }
    if(!has) return null;
    return tmp.toDataURL('image/png', 0.9);
  }catch(e){ return null; }
}

/* ---------- Export to PDF (jsPDF + autoTable) ---------- */
async function exportPDF(){
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF({unit:'pt', format:'a4'});
  const pageWidth = doc.internal.pageSize.getWidth();

  // header text (–≥–∞—Ä–∞–Ω—Ç–∏—è) ‚Äî —Ä–∞–∑–±–∏–≤–∞–µ–º –ø–æ —à–∏—Ä–∏–Ω–µ
  const headerText = "Biz kim quyidagi imzo chekuvchilar ushbu dalolatnomani tuzishimizdan maqsad shuki men manifestda qabul qilib olgan pochtalarimi o'z egalariga yetib borishi va ulardan olinadigan tulov summasini to'liq xolda qaytarib olib kelaman va pochtalarni butun xolda o'z egalariga yetib borishini kafolatlayman";
  doc.setFontSize(10);
  doc.setTextColor(20,20,30);
  doc.text(headerText, 40, 40, {maxWidth: pageWidth-80});

  // Title + meta
  doc.setFontSize(14); doc.setFont(undefined,'bold');
  doc.text(`–ú–∞–Ω–∏—Ñ–µ—Å—Ç ‚Äî –∫—É—Ä—å–µ—Ä: ${selectedCourier}`, 40, 100);
  doc.setFontSize(10); doc.setFont(undefined,'normal');
  doc.text(`–î–∞—Ç–∞: ${manifestDate.value}`, 40, 118);
  if(manifestNote.value) doc.text(`–ü—Ä–∏–º–µ—á–∞–Ω–∏–µ: ${manifestNote.value}`, 40, 132);

  // –¢–∞–±–ª–∏—Ü–∞: —Å–æ–±–µ—Ä—ë–º –¥–∞–Ω–Ω—ã–µ
  const body = [];
  qsa('#manifestTable tbody tr').forEach((tr,i)=>{
    const id = tr.querySelector('td[data-col="id"]').innerText;
    const name = tr.querySelector('td[data-col="name"]').innerText;
    const phone = tr.querySelector('td[data-col="phone"]').innerText;
    const addr = tr.querySelector('td[data-col="addr"]').innerText;
    const sum = tr.querySelector('td[data-col="sum"]').innerText;
    body.push([String(i+1), id, name, phone, addr, sum]);
  });

  // –ï—Å–ª–∏ –ø—É—Å—Ç–æ ‚Äî –ø—Ä–µ–¥—É–ø—Ä–µ–¥–∏–º
  if(body.length===0){ alert('–¢–∞–±–ª–∏—Ü–∞ –ø—É—Å—Ç–∞ ‚Äî –¥–æ–±–∞–≤–∏—Ç—å —Ö–æ—Ç—è –±—ã –æ–¥–Ω—É —Å—Ç—Ä–æ–∫—É'); return; }

  // AutoTable
  doc.autoTable({
    startY: 150,
    head: [['#','ID –ø–æ—á—Ç—ã','–ü–æ–ª—É—á–∞—Ç–µ–ª—å','–¢–µ–ª–µ—Ñ–æ–Ω','–ê–¥—Ä–µ—Å','–°—É–º–º–∞']],
    body,
    styles: { fontSize: 9, overflow:'linebreak' },
    headStyles: { fillColor: [124,58,237], textColor: 255, halign:'center' },
    columnStyles: {
      0: {cellWidth: 24},
      5: {halign:'right', cellWidth: 70}
    },
    theme: 'grid',
    margin: {left:40, right:40}
  });

  // totals
  const finalY = doc.lastAutoTable.finalY + 10;
  const total = totalSumEl.innerText;
  doc.setFontSize(11); doc.text(`–ò–¢–û–ì–û: ${total} —Å—É–º`, pageWidth-140, finalY+10, {align:'right'});

  // –ü–æ–¥–ø–∏—Å–∏ (–≤—Å—Ç–∞–≤–∏–º –∫–∞—Ä—Ç–∏–Ω–∫–∏ –µ—Å–ª–∏ –µ—Å—Ç—å)
  const signCourierData = getSignatureDataURL('signCourier');
  const signReceiverData = getSignatureDataURL('signReceiver');
  const signY = finalY + 50;

  // Boxes for signatures
  doc.setDrawColor(0); doc.setLineWidth(0.5);
  doc.rect(60, signY, 220, 80); // courier box
  doc.rect(pageWidth-280, signY, 220, 80); // receiver box

  doc.setFontSize(10);
  doc.text('–ü–æ–¥–ø–∏—Å—å –∫—É—Ä—å–µ—Ä–∞', 60, signY+95);
  doc.text('–ü–æ–¥–ø–∏—Å—å –ø—Ä–∏–Ω–∏–º–∞—é—â–µ–≥–æ', pageWidth-280, signY+95);

  if(signCourierData){
    // scale image to fit box
    doc.addImage(signCourierData, 'PNG', 70, signY+8, 200, 60);
  }
  if(signReceiverData){
    doc.addImage(signReceiverData, 'PNG', pageWidth-270, signY+8, 200, 60);
  }

  // Save PDF
  doc.save(`manifest_${new Date().toISOString().slice(0,19).replace(/[:T]/g,'-')}.pdf`);
}

/* ---------- –ü–µ—á–∞—Ç—å (chrome-friendly) ---------- */
qs('#btnPrint').addEventListener('click', ()=>{
  // –ø—Ä–æ—Å—Ç–∞—è –ø–µ—á–∞—Ç—å —Ç–µ–∫—É—â–µ–≥–æ –æ–∫–Ω–∞ (–º–æ–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å)
  window.print();
});

</script>
</body>
</html>
